#
# Copyright (C) 2020 The LineageOS Project
#
# SPDX-License-Identifier: Apache-2.0
#

on early-init
    # ZRAM setup
    write /sys/block/zram0/comp_algorithm lz4
    write /proc/sys/vm/page-cluster 0

on fs
    # for android.hardware.health@2.0-service.leeco_8996 cycle count backup
    mkdir /mnt/vendor/persist/battery 0700 system system

    exec u:r:vendor_toolbox:s0 root audio bluetooth graphics media net_raw system vendor_rfs vendor_rfs_shared wifi -- /vendor/bin/toybox_vendor find /mnt/vendor/persist -type d -exec /vendor/bin/toybox_vendor setfattr -x security.sehash {} \;
    restorecon_recursive /mnt/vendor/persist

on post-fs-data
    # Sensors
    chown system system /mnt/vendor/persist/sensors/gyro_sensitity_cal

    # Create directory for thermal engine
    mkdir /data/vendor/thermal 0771 root system
    mkdir /data/vendor/thermal/config 0771 root system

    # Create folder for our hex edited mm-qcamera-daemon and camera blobs
    mkdir /data/vendor/qcam 0770 camera camera

on early-boot

    # vendor.health-hal needs to be able to RW
    chown system system /sys/devices/soc/qpnp-fg-18/cycle_counts_bins
    # HardwareInfo needs to be able to read CC bins
    chmod 644 /sys/devices/soc/qpnp-fg-18/cycle_counts_bins

    # dumpstate needs to read, vendor.health-hal needs to be able to RW
    chown system system /sys/devices/soc/qpnp-fg-18/power_supply/bms/charge_full
    # HardwareInfo needs to be able to read charge_full
    chmod 644 /sys/devices/soc/qpnp-fg-18/power_supply/bms/charge_full

on boot
    # Secure touch
    chmod 0660 /sys/devices/soc/75ba000.i2c/i2c-12/12-004a/secure_touch_enable
    chmod 0440 /sys/devices/soc/75ba000.i2c/i2c-12/12-004a/secure_touch
    chown system drmrpc /sys/devices/soc/75ba000.i2c/i2c-12/12-004a/secure_touch_enable
    chown system drmrpc /sys/devices/soc/75ba000.i2c/i2c-12/12-004a/secure_touch
    #write /sys/devices/soc/75ba000.i2c/i2c-12/12-0020/input/input0/update_fw 1

    # Torch
    chown system system /sys/class/leds/torch-light0/brightness
    chown system system /sys/class/leds/torch-light1/brightness
    chmod 0666 /sys/class/leds/torch-light0/brightness
    chmod 0666 /sys/class/leds/torch-light1/brightness

    # Graphics
    #create symlink for fb1 as HDMI
    symlink /dev/graphics/fb1 /dev/graphics/hdmi

    # Set graphic node permissions
    chown system graphics /sys/class/graphics/fb0/mdp/bw_mode_bitmap
    chown system graphics /sys/class/graphics/fb0/mdp/vfps_fcnt
    chown system graphics /sys/class/graphics/fb0/mdp/vfps
    chown system graphics /sys/class/graphics/fb0/mdp/vfps_ratio
    chown system graphics /sys/class/graphics/fb0/idle_time
    chown system graphics /sys/class/graphics/fb0/dynamic_fps
    chown system graphics /sys/class/graphics/fb0/dyn_pu
    chown system graphics /sys/class/graphics/fb0/modes
    chown system graphics /sys/class/graphics/fb0/mode
    chown system graphics /sys/class/graphics/fb0/msm_cmd_autorefresh_en
    chown system graphics /sys/class/graphics/fb0/sp_link_backlight_off
    chmod 0664 /sys/class/graphics/fb0/mdp/bw_mode_bitmap
    chmod 0644 /sys/class/graphics/fb0/mdp/vfps
    chmod 0644 /sys/class/graphics/fb0/mdp/vfps_fcnt
    chmod 0644 /sys/class/graphics/fb0/mdp/vfps_ratio
    chmod 0664 /sys/class/graphics/fb0/idle_time
    chmod 0664 /sys/class/graphics/fb0/dynamic_fps
    chmod 0664 /sys/class/graphics/fb0/dyn_pu
    chmod 0664 /sys/class/graphics/fb0/modes
    chmod 0664 /sys/class/graphics/fb0/mode
    chmod 0664 /sys/class/graphics/fb0/msm_cmd_autorefresh_en
    chmod 0644 /sys/class/graphics/fb0/sp_link_backlight_off

    chown system graphics /sys/class/graphics/fb1/hdcp/tp
    chown system graphics /sys/class/graphics/fb1/hpd
    chown system graphics /sys/class/graphics/fb1/vendor_name
    chown system graphics /sys/class/graphics/fb1/product_description
    chown system graphics /sys/class/graphics/fb1/res_info
    chown system graphics /sys/class/graphics/fb1/video_mode
    chown system graphics /sys/class/graphics/fb1/s3d_mode
    chown system graphics /sys/class/graphics/fb1/cec/enable
    chown system graphics /sys/class/graphics/fb1/cec/logical_addr
    chown system graphics /sys/class/graphics/fb1/cec/rd_msg
    chown system graphics /sys/class/graphics/fb1/pa
    chown system graphics /sys/class/graphics/fb1/cec/wr_msg
    chmod 664 /sys/class/graphics/fb1/hdcp/tp
    chmod 664 /sys/class/graphics/fb1/hpd
    chmod 664 /sys/class/graphics/fb1/vendor_name
    chmod 664 /sys/class/graphics/fb1/product_description
    chmod 664 /sys/class/graphics/fb1/res_info
    chmod 664 /sys/class/graphics/fb1/video_mode
    chmod 664 /sys/class/graphics/fb1/s3d_mode
    chmod 664 /sys/class/graphics/fb1/cec/enable
    chmod 664 /sys/class/graphics/fb1/cec/logical_addr
    chmod 664 /sys/class/graphics/fb1/cec/rd_msg
    chmod 664 /sys/class/graphics/fb1/pa
    chmod 600 /sys/class/graphics/fb1/cec/wr_msg

    # Set permissions so radio can read
    chmod 0444 /proc/cmdline

    # for fingerprint calibration
    chown system system /mnt/vendor/persist/qc_senseid/bg_estimation/bg_basis.dat
    chown system system /mnt/vendor/persist/qc_senseid/bg_estimation/bg_small1_basis.dat
    chown system system /mnt/vendor/persist/qc_senseid/bg_estimation/bg_small1_off_basis.dat
    chown system system /mnt/vendor/persist/qc_senseid/bg_estimation/bg_small2_basis.dat
    chown system system /mnt/vendor/persist/qc_senseid/bg_estimation/bg_small2_off_basis.dat

    # Don't reset entire SoC on individual subsystem crash
    write /sys/bus/msm_subsys/devices/subsys0/restart_level "related"
    write /sys/bus/msm_subsys/devices/subsys1/restart_level "related"
    write /sys/bus/msm_subsys/devices/subsys2/restart_level "related"
    write /sys/bus/msm_subsys/devices/subsys3/restart_level "related"
    write /sys/bus/msm_subsys/devices/subsys4/restart_level "related"
    write /sys/bus/msm_subsys/devices/subsys5/restart_level "related"

on property:sys.boot_completed=1
    # Enable ZRAM on boot_complete
    swapon_all /vendor/etc/fstab.qcom
    # Enable hvdcp
    setprop persist.hvdcp.allow_opti 1

# Start camera server as daemon
service qcamerasvr /vendor/bin/mm-qcamera-daemon
    override
    class late_start
    user camera
    group camera system inet input graphics
    writepid /dev/cpuset/camera-daemon/tasks

service thermal-engine /vendor/bin/thermal-engine -c ${sys.qcom.thermalcfg:-/vendor/etc/thermal-engine.conf}
    override
    class main
    user root
    socket thermal-send-client stream 0666 system system
    socket thermal-recv-client stream 0660 system system
    socket thermal-recv-passive-client stream 0666 system system
    socket thermal-send-rule stream 0660 system system
    group system root diag
    writepid /dev/cpuset/system-background/tasks

on property:vold.decrypt=trigger_reset_main
    stop vendor.audio-hal-2-0

on property:vold.decrypt=trigger_shutdown_framework
    stop vendor.audio-hal-2-0

on property:vold.decrypt=trigger_restart_min_framework
    start vendor.audio-hal-2-0

on property:vold.decrypt=trigger_restart_framework
    restart vendor.camera-provider-2-4
    start vendor.audio-hal-2-0

service proc-touchpanel-sh /vendor/bin/init.proc_touchpanel.sh
    class late_start
    user root
    group root system
    oneshot

service vendor.msm_irqbalance /vendor/bin/msm_irqbalance -f /vendor/etc/msm_irqbalance.conf
    override
    socket msm_irqbalance seqpacket 660 root system
    class core
    user root
    group root
    writepid /dev/cpuset/system-background/tasks

service vendor.hvdcp_opti /vendor/bin/hvdcp_opti
    override
    class main
    user root
    group system wakelock
    seclabel u:r:hvdcp:s0

service vendor.charger /vendor/bin/charger
    class charger
    user system
    group system graphics input log
    capabilities SYS_BOOT
    seclabel u:r:vendor_charger:s0
    writepid /dev/cpuset/system-background/tasks

on property:persist.sys.le_fast_chrg_enable=1
    write /sys/class/power_supply/le_ab/le_quick_charge_mode 0

on property:persist.sys.le_fast_chrg_enable=0
    write /sys/class/power_supply/le_ab/le_quick_charge_mode 1
